from .abstractrest import AbstractRESTTestCase
from  iclientpy.rest.apifactory import APIFactory
import httpretty
from iclientpy.rest.decorator import HttpMethod
from iclientpy.rest.api.datacatalog import Datacatalog


class DatacatalogTestCase(AbstractRESTTestCase):
    @classmethod
    def setUpClass(cls):
        cls.init_rest(cls)
        cls.init_apifactory(cls)
        cls.init_api(cls, APIFactory.datacatalog_service)

    def test_relationship(self):
        datasets_jsonstr = '{"datasetCount":4,"datasetNames":["newyorkPoint_P_2019146273","newyorkRoads_L_2019146273","newyorkZone_R_2019146273","singleRegion_R_2019146273"],"childUriList":["http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkRoads_L_2019146273","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkZone_R_2019146273","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/singleRegion_R_2019146273"]}'
        dataset_jsonstr = '{"childUriList":["http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273//fields"],"supportAttachments":false,"supportFeatureMetadatas":false,"datasetInfo":{"charset":"UTF8","recordCount":144376,"isFileCache":false,"description":"NULL","type":"POINT","dataSourceName":"supermap_pg","tableName":"SMDTV_4","isReadOnly":false,"encodeType":"NONE","bounds":{"top":40.901577,"left":-74.342308,"bottom":40.576233,"leftBottom":{"x":-74.342308,"y":40.576233},"right":-73.58014699999998,"rightTop":{"x":-73.58014699999998,"y":40.901577}},"name":"newyorkPoint_P_2019146273","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---GCS_WGS_1984","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"D_WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS_1984","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"GCS_WGS_1984","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"datasourceConnectionInfo":{"dataBase":"supermap","server":"192.168.20.182","password":"supermap","driver":"PostgreSQL ANSI","openLinkTable":false,"alias":"supermap_pg","engineType":"POSTGRESQL","exclusive":false,"readOnly":false,"user":"postgres","connect":true}}}'
        fields_jsonstr = '{"fieldNames":["SMID","SMX","SMY","SMLIBTILEID","SMUSERID","MEDALLION","HACK_LICENSE","VECDOR_ID","RATE_CODE","STORE_AND_FWD_FLAG","PICKUP_DATETIME","DROPOFF_DATETIME","PASSENGER_COUNT","TRIP_TIME_IN_SECS","TRIP_DISTANCE","PICKUP_LONGITUDE","PICKUP_LATITUDE","DROPOFF_LONGITUDE","DROPOFF_LATITUDE"],"childUriList":["http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//SMID","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//SMX","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//SMY","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//SMLIBTILEID","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//SMUSERID","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//MEDALLION","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//HACK_LICENSE","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//VECDOR_ID","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//RATE_CODE","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//STORE_AND_FWD_FLAG","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//PICKUP_DATETIME","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//DROPOFF_DATETIME","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//PASSENGER_COUNT","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//TRIP_TIME_IN_SECS","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//TRIP_DISTANCE","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//PICKUP_LONGITUDE","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//PICKUP_LATITUDE","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//DROPOFF_LONGITUDE","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields//DROPOFF_LATITUDE"]}'
        field_jsonstr = '{"childUriList":null,"fieldInfo":{"isRequired":true,"defaultValue":"","name":"SMID","caption":"SmID","type":"INT32","maxLength":4,"isZeroLengthAllowed":false,"isSystemField":true}}'
        self.check_api(Datacatalog.head_relationship_datasets,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/relationship/datasets.json",
                       HttpMethod.HEAD, httpretty.Response(status=200, body=datasets_jsonstr))
        self.check_api(Datacatalog.get_relationship_datasets,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/relationship/datasets.json",
                       HttpMethod.GET, httpretty.Response(status=200, body=datasets_jsonstr))
        self.check_api(Datacatalog.head_relationship_dataset,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273.json",
                       HttpMethod.HEAD, httpretty.Response(status=200, body=dataset_jsonstr),
                       dataset_name='newyorkPoint_P_2019146273')
        self.check_api(Datacatalog.get_relationship_dataset,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273.json",
                       HttpMethod.GET, httpretty.Response(status=200, body=dataset_jsonstr),
                       dataset_name='newyorkPoint_P_2019146273')
        self.check_api(Datacatalog.head_relationship_dataset_fields,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields.json",
                       HttpMethod.HEAD, httpretty.Response(status=200, body=fields_jsonstr),
                       dataset_name='newyorkPoint_P_2019146273')
        self.check_api(Datacatalog.get_relationship_dataset_fields,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields.json",
                       HttpMethod.GET, httpretty.Response(status=200, body=fields_jsonstr),
                       dataset_name='newyorkPoint_P_2019146273')
        self.check_api(Datacatalog.head_relationship_dataset_field,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields/SMID.json",
                       HttpMethod.HEAD, httpretty.Response(status=200, body=field_jsonstr),
                       dataset_name='newyorkPoint_P_2019146273', field_name='SMID')
        self.check_api(Datacatalog.get_relationship_dataset_field,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/relationship/datasets/newyorkPoint_P_2019146273/fields/SMID.json",
                       HttpMethod.GET, httpretty.Response(status=200, body=field_jsonstr),
                       dataset_name='newyorkPoint_P_2019146273', field_name='SMID')

    def test_sharefile(self):
        datasets_jsonstr = '{"datasetCount":5,"datasetNames":["smtiles_newyork_taxi","smtiles_processing_newyorkZone_R","smtiles_processing_singleRegion_R","smtiles_processing_newyorkRoads_L","smtiles_processing_newyorkPoint_P"],"childUriList":["http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_newyork_taxi","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkZone_R","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_singleRegion_R","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkRoads_L","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P"]}'
        dataset_jsonstr = '{"childUriList":["http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P//fields"],"supportAttachments":false,"supportFeatureMetadatas":false,"datasetInfo":{"fieldInfos":[{"isRequired":true,"defaultValue":"","name":"SmID","caption":"SmID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmX","caption":"SmX","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmY","caption":"SmY","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":false,"defaultValue":"1","name":"SmLibTileID","caption":"SmLibTileID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmUserID","caption":"SmUserID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"0","name":"SmGeometrySize","caption":"SmGeometrySize","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"-1","name":"SmGeoPosition","caption":"SmGeoPosition","type":"INT64","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":false,"defaultValue":"","name":"medallion","caption":"medallion","type":"WTEXT","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"hack_license","caption":"hack_license","type":"WTEXT","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"vecdor_id","caption":"vecdor_id","type":"WTEXT","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"rate_code","caption":"rate_code","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"store_and_fwd_flag","caption":"store_and_fwd_flag","type":"WTEXT","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"pickup_datetime","caption":"pickup_datetime","type":"DATETIME","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"dropoff_datetime","caption":"dropoff_datetime","type":"DATETIME","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"passenger_count","caption":"passenger_count","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"trip_time_in_secs","caption":"trip_time_in_secs","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"trip_distance","caption":"trip_distance","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"pickup_longitude","caption":"pickup_longitude","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"pickup_latitude","caption":"pickup_latitude","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"dropoff_longitude","caption":"dropoff_longitude","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"dropoff_latitude","caption":"dropoff_latitude","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false}],"epsgCode":4326,"datasetName":"newyorkPoint_P","bounds":"Left=-74.342308,Bottom=40.576233,Right=-73.58014699999998,Top=40.901577","available":true,"name":"smtiles_processing_newyorkPoint_P","readOnly":false,"datasetType":"POINT","type":"UDB","url":"F:\\BaiduNetdiskDownload\\data\\processing.udb"}}'
        fields_jsonstr = '{"fieldNames":["SmID","SmX","SmY","SmLibTileID","SmUserID","SmGeometrySize","SmGeoPosition","medallion","hack_license","vecdor_id","rate_code","store_and_fwd_flag","pickup_datetime","dropoff_datetime","passenger_count","trip_time_in_secs","trip_distance","pickup_longitude","pickup_latitude","dropoff_longitude","dropoff_latitude"],"childUriList":["http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//SmID","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//SmX","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//SmY","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//SmLibTileID","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//SmUserID","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//SmGeometrySize","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//SmGeoPosition","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//medallion","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//hack_license","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//vecdor_id","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//rate_code","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//store_and_fwd_flag","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//pickup_datetime","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//dropoff_datetime","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//passenger_count","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//trip_time_in_secs","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//trip_distance","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//pickup_longitude","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//pickup_latitude","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//dropoff_longitude","http://localhost:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields//dropoff_latitude"]}'
        field_jsonstr = '{"childUriList":null,"fieldInfo":{"isRequired":true,"defaultValue":"","name":"SmID","caption":"SmID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true}}'
        self.check_api(Datacatalog.head_sharefile,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/sharefile.json",
                       HttpMethod.HEAD, httpretty.Response(status=200, body=datasets_jsonstr))
        self.check_api(Datacatalog.get_sharefile,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/sharefile.json",
                       HttpMethod.GET, httpretty.Response(status=200, body=datasets_jsonstr))
        self.check_api(Datacatalog.head_sharefile_dataset,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P.json",
                       HttpMethod.HEAD, httpretty.Response(status=200, body=dataset_jsonstr),
                       dataset_name='smtiles_processing_newyorkPoint_P')
        self.check_api(Datacatalog.get_sharefile_dataset,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P.json",
                       HttpMethod.GET, httpretty.Response(status=200, body=dataset_jsonstr),
                       dataset_name='smtiles_processing_newyorkPoint_P')
        self.check_api(Datacatalog.head_sharefile_dataset_fields,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields.json",
                       HttpMethod.HEAD, httpretty.Response(status=200, body=fields_jsonstr),
                       dataset_name='smtiles_processing_newyorkPoint_P')
        self.check_api(Datacatalog.get_sharefile_dataset_fields,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields.json",
                       HttpMethod.GET, httpretty.Response(status=200, body=fields_jsonstr),
                       dataset_name='smtiles_processing_newyorkPoint_P')
        self.check_api(Datacatalog.head_sharefile_dataset_field,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields/SmID.json",
                       HttpMethod.HEAD, httpretty.Response(status=200, body=field_jsonstr),
                       dataset_name='smtiles_processing_newyorkPoint_P', field_name='SmID')
        self.check_api(Datacatalog.get_sharefile_dataset_field,
                       self.baseuri + "/services/datacatalog/rest/datacatalog/sharefile/smtiles_processing_newyorkPoint_P/fields/SmID.json",
                       HttpMethod.GET, httpretty.Response(status=200, body=field_jsonstr),
                       dataset_name='smtiles_processing_newyorkPoint_P', field_name='SmID')
