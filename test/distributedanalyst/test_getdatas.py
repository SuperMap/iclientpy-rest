from unittest import TestCase
from unittest.mock import MagicMock
from iclientpy.codingui.distributedanalyst import get_datas
from iclientpy.rest.api.datacatalog import Datacatalog
from iclientpy.rest.api.model import DatasetsContent, FieldsContent,RelationShipDatasetContent, \
    BigDataFileShareDatasetContent
from iclientpy.dtojson import deserializer
from iclientpy.rest.api.distributedanalyst import DistributedAnalyst


class TestGetDatas(TestCase):

    def test(self):
        r_sharefile = '{"datasetCount":3,"datasetNames":["s_newyork_taxi","s_processing_newyorkZone_R","s_processing_newyorkPoint_P"],"childUriList":["http://192.168.20.182:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/s_newyork_taxi","http://192.168.20.182:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/s_processing_newyorkPoint_P"]}'
        r_sharefile_network_taxi = '{"childUriList":["http://192.168.20.182:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/s_newyork_taxi//fields"],"supportAttachments":false,"supportFeatureMetadatas":false,"datasetInfo":{"firstRowIsHead":false,"xIndex":-1,"available":false,"name":"s_newyork_taxi","prjCoordsys":4326,"yIndex":-1,"fieldInfo":[{"name":"col0","type":"WTEXT"},{"name":"col1","type":"WTEXT"},{"name":"col2","type":"WTEXT"},{"name":"col3","type":"INT32"},{"name":"col4","type":"WTEXT"},{"name":"col5","type":"WTEXT"},{"name":"col6","type":"WTEXT"},{"name":"col7","type":"INT32"},{"name":"col8","type":"INT32"},{"name":"col9","type":"DOUBLE"},{"name":"col10","type":"DOUBLE"},{"name":"col11","type":"DOUBLE"},{"name":"col12","type":"DOUBLE"},{"name":"col13","type":"DOUBLE"}],"type":"CSV","separator":",","url":"/home/supermap/sharefloder/newyork_taxi.csv"}}'
        r_sharefile__newyorkZone_R = '{"childUriList":["http://192.168.20.182:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/s_processing_newyorkZone_R//fields"],"supportAttachments":false,"supportFeatureMetadatas":false,"datasetInfo":{"fieldInfos":[{"isRequired":true,"defaultValue":"","name":"SmID","caption":"SmID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmSdriW","caption":"SmSdriW","type":"SINGLE","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmSdriN","caption":"SmSdriN","type":"SINGLE","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmSdriE","caption":"SmSdriE","type":"SINGLE","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmSdriS","caption":"SmSdriS","type":"SINGLE","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmUserID","caption":"SmUserID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":true,"defaultValue":"0","name":"SmArea","caption":"SmArea","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmPerimeter","caption":"SmPerimeter","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":false,"defaultValue":"0","name":"SmGeometrySize","caption":"SmGeometrySize","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"-1","name":"SmGeoPosition","caption":"SmGeoPosition","type":"INT64","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":false,"defaultValue":"","name":"OBJECTID","caption":"OBJECTID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"Shape_Leng","caption":"Shape_Leng","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"Shape_Area","caption":"Shape_Area","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"zone","caption":"zone","type":"WTEXT","maxLength":254,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"LocationID","caption":"LocationID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"borough","caption":"borough","type":"WTEXT","maxLength":254,"isZeroLengthAllowed":true,"isSystemField":false}],"epsgCode":4326,"datasetName":"newyorkZone_R","bounds":"Left=-74.25551784310493,Bottom=40.496084221255856,Right=-73.70014827248451,Top=40.91538866049913","available":true,"name":"s_processing_newyorkZone_R","readOnly":false,"datasetType":"REGION","type":"UDB","url":"/home/supermap/sharefloder/processing.udb"}}'
        r_sharefile__newyorkPoint_P = '{"childUriList":["http://192.168.20.182:8090/iserver/services/datacatalog/rest/datacatalog/sharefile/s_processing_newyorkPoint_P//fields"],"supportAttachments":false,"supportFeatureMetadatas":false,"datasetInfo":{"fieldInfos":[{"isRequired":true,"defaultValue":"","name":"SmID","caption":"SmID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmX","caption":"SmX","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmY","caption":"SmY","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":false,"defaultValue":"1","name":"SmLibTileID","caption":"SmLibTileID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"0","name":"SmUserID","caption":"SmUserID","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"0","name":"SmGeometrySize","caption":"SmGeometrySize","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":true,"defaultValue":"-1","name":"SmGeoPosition","caption":"SmGeoPosition","type":"INT64","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":true},{"isRequired":false,"defaultValue":"","name":"medallion","caption":"medallion","type":"WTEXT","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"hack_license","caption":"hack_license","type":"WTEXT","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"vecdor_id","caption":"vecdor_id","type":"WTEXT","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"rate_code","caption":"rate_code","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"store_and_fwd_flag","caption":"store_and_fwd_flag","type":"WTEXT","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"pickup_datetime","caption":"pickup_datetime","type":"DATETIME","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"dropoff_datetime","caption":"dropoff_datetime","type":"DATETIME","maxLength":255,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"passenger_count","caption":"passenger_count","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"trip_time_in_secs","caption":"trip_time_in_secs","type":"INT32","maxLength":4,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"trip_distance","caption":"trip_distance","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"pickup_longitude","caption":"pickup_longitude","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"pickup_latitude","caption":"pickup_latitude","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"dropoff_longitude","caption":"dropoff_longitude","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false},{"isRequired":false,"defaultValue":"","name":"dropoff_latitude","caption":"dropoff_latitude","type":"DOUBLE","maxLength":8,"isZeroLengthAllowed":true,"isSystemField":false}],"epsgCode":4326,"datasetName":"newyorkPoint_P","bounds":"Left=-74.342308,Bottom=40.576233,Right=-73.58014699999998,Top=40.901577","available":true,"name":"s_processing_newyorkPoint_P","readOnly":false,"datasetType":"POINT","type":"UDB","url":"/home/supermap/sharefloder/processing.udb"}}'

        r_relationship_datasets = '{"datasetCount":1,"datasetNames":["analystResult_130552027"],"childUriList":["http://192.168.20.182:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/analystResult_130552027"]}'
        r_relationship_analystResult_130552027 = '{"childUriList":["http://192.168.20.182:8090/iserver/services/datacatalog/rest/datacatalog/relationship/datasets/analystResult_130552027//fields"],"supportAttachments":false,"supportFeatureMetadatas":false,"datasetInfo":{"charset":"UTF8","recordCount":6414,"isFileCache":false,"description":"","type":"REGION","dataSourceName":"supermap_pg","tableName":"SMDTV_1","isReadOnly":false,"encodeType":"NONE","bounds":{"top":40.849904671748604,"left":-74.04927681498597,"bottom":40.650255180584914,"leftBottom":{"x":-74.04927681498597,"y":40.650255180584914},"right":-73.84962732382229,"rightTop":{"x":-73.84962732382229,"y":40.849904671748604}},"name":"analystResult_130552027","prjCoordSys":{"distanceUnit":"METER","projectionParam":null,"epsgCode":4326,"coordUnit":"DEGREE","name":"Longitude / Latitude Coordinate System---WGS 84","projection":null,"type":"PCS_EARTH_LONGITUDE_LATITUDE","coordSystem":{"datum":{"name":"WGS_1984","type":"DATUM_WGS_1984","spheroid":{"flatten":0.00335281066474748,"name":"WGS 84","axis":6378137,"type":"SPHEROID_WGS_1984"}},"unit":"DEGREE","spatialRefType":"SPATIALREF_EARTH_LONGITUDE_LATITUDE","name":"WGS 84","type":"GCS_WGS_1984","primeMeridian":{"longitudeValue":0,"name":"Greenwich","type":"PRIMEMERIDIAN_GREENWICH"}}},"datasourceConnectionInfo":{"dataBase":"supermap","server":"192.168.20.182","password":"supermap","driver":"PostgreSQL ANSI","openLinkTable":false,"alias":"supermap_pg","engineType":"POSTGRESQL","exclusive":false,"readOnly":false,"user":"postgres","connect":true}}}'

        datasets_deserializer = deserializer(DatasetsContent)
        datacatlog = Datacatalog()
        datacatlog.get_sharefile = MagicMock(return_value=datasets_deserializer(r_sharefile))

        filesharedataset_deserializer = deserializer(BigDataFileShareDatasetContent)
        filesharedataset_deserializer(r_sharefile__newyorkPoint_P)
        datacatlog.get_sharefile_dataset = MagicMock(side_effect =[filesharedataset_deserializer(r_sharefile_network_taxi),filesharedataset_deserializer(r_sharefile__newyorkZone_R),filesharedataset_deserializer(r_sharefile__newyorkPoint_P)])
        empty_fileds_content = FieldsContent()
        empty_fileds_content.fieldNames = []
        datacatlog.get_sharefile_dataset_fields = MagicMock(return_value=empty_fileds_content)

        datacatlog.get_relationship_datasets = MagicMock(return_value=datasets_deserializer(r_relationship_datasets))
        deserializer(RelationShipDatasetContent)
        datacatlog.get_relationship_dataset = MagicMock(return_value=deserializer(RelationShipDatasetContent)(r_relationship_analystResult_130552027))
        datacatlog.get_relationship_dataset_fields = MagicMock(return_value=empty_fileds_content)
        attach = MagicMock()
        datas = get_datas(datacatlog, [attach])
        attach.assert_called_once()